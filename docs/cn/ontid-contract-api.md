# ONT ID Contract API

[ONT ID](./ONTID_protocol_spec_cn.md)的管理功能由一个native合约实现。合约地址是0x0000000000000000000000000000000000000003。

## 接口

### 数据结构

#### 管理组

```
Group {
    threshold    //门限，整数
    members      //成员数组
}
```

其中成员数组中的每个成员是一个字节串，根据前8个字节是否为"did:ont:"判断是一个ONT ID或一个嵌套的Group结构体。若是ONT ID，则必须是已注册的自主管理的ONT ID。

#### 签名人

```
Signer {
    id     //签名人ONT ID
    index  //验签公钥编号
}
```


#### 属性

```
Attribute {
    key      //属性的键，字节串
    type     //属性的类型，字节串
    value    //属性的值，字节串
}
```


### regIDWithPublicKey


注册自主管理的ONT ID

参数：

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | 注册的ONT ID
 1  |  字节串  | 所有者的公钥

调用此接口需提供参数中的公钥对应私钥的签名。注册完成后此公钥即与ONT ID绑定。

触发事件：("Register", ONT ID)


### regIDWithController

注册代理控制的ONT ID

参数：

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | 注册的ONT ID
 1  |  字节串  | 代理控制人
 2  |  整数/字节串 | 签名公钥编号/序列化的签名人数组

参数1的字节串即可以是一个ONT ID，也可以是一个序列化的管理组结构体，根据前8个字节加以区分。

调用此接口需要提供代理控制人的有效签名。代理控制人若是一个ONT ID，则参数2为验签公钥的编号；若是一个管理组，则参数2是签名人列表。

触发事件：("Register", ONT ID)


### revokeID

废弃自主管理的ONT ID

参数：

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | 注册的ONT ID
 1  |  整数    | 所有者的验签公钥编号

触发事件：("Revoke", ONT ID)


### revokeIDByController

废弃代理控制的ONT ID

参数：

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | 注册的ONT ID
 1  |  整数/字节串 | 签名公钥编号/序列化的签名人数组

触发事件：("Revoke", ONT ID)


### removeController

撤销代理控制人

参数:

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | ONT ID
 1  |  整数    | 所有者的验签公钥编号

调用此接口需提供所有者的签名，并通过参数1指明验签公钥的编号。

触发事件：("RemoveController", ONT ID)


### setRecovery

设置恢复人

参数:

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | ONT ID
 1  |  字节串  | 恢复人，为序列化的管理人数组
 2  |  整数    | 验签公钥

调用此接口需提供所有者的签名，并通过参数2指明验签公钥的编号。

触发事件：("Recovery", "set", ONT ID, JSON形式表示的恢复人)


### updateRecovery

更新恢复人

参数:

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | ONT ID
 1  |  字节串  | 新恢复人，为序列化的管理人数组
 2  |  字节串  | 签名人列表，为序列化的签名人数组

调用此接口需提供原恢复人的有效签名。

触发事件：("Recovery", "update", ONT ID, JSON形式表示的新恢复人)


### addKey

所有者添加公钥

参数：

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | ONT ID
 1  |  字节串  | 添加的新公钥
 2  |  字节串  | 验签公钥

调用此接口需提供所有者的签名，并通过参数2给出验签公钥。验签公钥必须已绑定到该ID。

触发事件：("PublicKey", "add", ONT ID, 新公钥, 新公钥编号)


### removeKey

所有者废除公钥

参数：

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | ONT ID
 1  |  字节串  | 废除的公钥
 2  |  字节串  | 验签公钥

调用此接口需提供所有者的签名，并通过参数2给出验签公钥。验签公钥必须已绑定到该ID。

触发事件：("PublicKey", "remove", ONT ID, 废除的公钥, 废除公钥的编号)

### addKeyByController

代理控制人添加公钥

参数：

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | ONT ID
 1  |  字节串  | 添加的新公钥
 2  |  整数/字节串 | 签名公钥编号/序列化的签名人数组

调用此接口需要提供代理控制人的有效签名。代理控制人若是一个ONT ID，则参数2为验签公钥的编号；若是一个管理组，则参数2是签名人列表。

触发事件： ("PublicKey", "add by controller", ONT ID, 新公钥, 新公钥编号)


### addKeyByRecovery

恢复人添加公钥

参数:

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | ONT ID
 1  |  字节串  | 添加的新公钥
 2  |  字节串  | 序列化的签名人数组

调用此接口需提供恢复人的有效签名。

触发事件：("PublicKey", "add by recovery", ONT ID, 新公钥, 新公钥编号)


### removeKeyByRecovery

恢复人废除公钥

参数:

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | ONT ID
 1  |  整数    | 废除公钥的编号
 2  |  字节串  | 序列化的签名人数组

调用此接口需提供恢复人的有效签名。

触发事件：("PublicKey", "remove by recovery", ONT ID, 废除的公钥, 废除公钥的编号)


### regIDWithAttributes

注册ONT ID同时添加属性

编号 |  类型      | 说明
----|------------|-------
 0  |  字节串     | ONT ID
 1  |  字节串     | 所有者的公钥
 2  |  属性结构体数组 | 属性数组

调用此接口需提供所有者的签名，并通过参数1给出所有者公钥。注册完成后公钥与该ID绑定，且参数2给出的属性被添加到该ID中。

触发事件：("Register", ONT ID)


### addAttributes

所有者添加属性

参数:

编号 |  类型      | 说明
----|------------|-------
 0  |  字节串     | ONT ID
 1  |  属性结构体数组 | 属性数组
 2  |  字节串     | 验签公钥


调用此接口需提供所有者的签名，并通过参数2给出验签公钥。验签公钥必须已绑定到该ID。

触发事件：("Attribute", "add", ONT ID, 添加的属性键列表)


### removeAttribute

所有者删除属性

参数:

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | ONT ID
 1  |  字节串  | 删除属性的键
 2  |  字节串  | 验签公钥

调用此接口需提供所有者的签名，并通过参数2给出验签公钥。验签公钥必须已绑定到该ID。

触发事件：("Attribute", "remove", ONT ID, 删除属性的键)


### addAttributesByController

代理控制人添加属性

参数:

编号 |  类型      | 说明
----|------------|-------
 0  |  字节串     | ONT ID
 1  |  属性结构体数组  | 属性数组
 2  |  整数/字节串 | 签名公钥编号/序列化的签名人数组

调用此接口需要提供代理控制人的有效签名。代理控制人若是一个ONT ID，则参数2为验签公钥的编号；若是一个管理组，则参数2是签名人列表。

触发事件：("Attribute", "add by controller", ONT ID, 添加的属性键列表)


### removeAttributeByController

代理控制人删除属性

参数:

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | ONT ID
 1  |  字节串  | 删除属性的键
 2  |  整数/字节串 | 签名公钥编号/序列化的签名人数组

调用此接口需要提供代理控制人的有效签名。代理控制人若是一个ONT ID，则参数2为验签公钥的编号；若是一个管理组，则参数2是签名人列表。

触发事件：("Attribute", "remove by controller", ONT ID, 删除属性的键)


### VerifySignature

验证签名

参数：

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | ONT ID
 1  |  整数    | 公钥编号

接口调用的交易需包含被验证的签名，且通过参数1指明验证公钥的编号。

返回：True/False

### VerifyController

验证控制人签名

参数：

编号 |  类型   | 说明
----|---------|-------
 0  |  字节串  | ONT ID
 1  |  整数/签名人结构体数组  | 签名公钥编号/签名人列表


若控制人是一个ONT ID，则参数1数组中仅包含其一个元素；若是一个管理组，则需要列出所有参与的签名人。

调用接口的交易需包含所有被验证的签名。代理控制人若是一个ONT ID，则参数2为验签公钥的编号；若是一个管理组，则参数2是签名人列表。

返回：True/False


### 查询

查询类接口不需要经过共识，可直接通过预执行方式调用。


#### getPublicKeys

查询密钥

参数：

编号 |  类型   | 说明
----|---------|-------
 0  ｜ 字节串  ｜ ONT ID

返回： 字节串，为序列化后的密钥列表。每个密钥包含以下数据

```
PublicKey:
    KeyIndex    Int
    KeyData     ByteArray
```


#### getKeyState

查询密钥状态

参数：

编号 |  类型   | 说明
----|---------|-------
 0  | 字节串   | ONT ID
 1  |  整数    | 密钥编号

返回: "in use" | "revoked" | "not exist"


#### getAttributes

查询属性

参数：

编号 |  类型   | 说明
----|---------|-------
 0  | 字节串   | ONT ID


返回：字节串，为序列化后的属性列表。每个属性的数据结构见[属性](#属性)。


#### getDDO

查询ONT ID Document

参数：

编号 |  类型   | 说明
----|---------|-------
 0  | 字节串   | ONT ID


返回：序列化后的ONT ID相关信息，包含5个字节串，分别为

* 密钥，同[getPublicKeys](#getPublicKeys)的返回值
* 属性，同[getAttributes](#getAttributes)的返回值
* 恢复人（废弃），为旧版的恢复人数据，应为空
* 控制人，若不存在控制人，则为空，否则为一个ONT ID（单控制人）或一个JSON对象（多控制人）
* 恢复人，若不存在恢复人，则为空，否则为一个JSON对象


### 废弃的方法

以下方法废弃，但因历史数据兼容性问题仍保留。

addRecovery

changeRecovery



## 存储

所有数据均存储在此合约空间内，即存储的键添加合约地址作为前缀。方便起见，以下列出的存储键均省略前缀。

符号说明：

* `+` 表示连接前后字节串
* `ID` 表示ONT ID


存储内容 |   键      |   值        | 备注
--------|----------|-------------|-----
注册标记 |  `ID`     | `0x01`      | 作为ONT ID的存在标记
公钥     | `ID+0x01` | 公钥列表     | 记录ONT ID绑定的公钥，包括已废弃的公钥
属性     | `ID+0x02` | 属性列表     | 以链表形式存储ONT ID的属性，便于删除操作
恢复人   | `ID+0x03` | 管理组结构体  | 存储的结构体与接口传入的相同
控制人   | `ID+0x04` | ONT ID或管理组结构体 |
版本号   | `0x00`    |  `0x01`     | 标示当前存储版本，用于非兼容处理，目前取值为1
